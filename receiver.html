<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawblins Cast Receiver</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        .cast-display {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        /* Header with room code and timer */
        .cast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 4rem;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .cast-title {
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .cast-timer {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1.5rem 3rem;
            border-radius: 40px;
            font-size: 3rem;
            font-weight: bold;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .cast-timer.timer-urgent {
            background: #e74c3c;
        }
        
        .cast-room-info {
            text-align: right;
        }
        
        .cast-room-code {
            font-size: 1.2rem;
            opacity: 0.8;
            margin: 0;
        }
        
        .cast-room-code-value {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0 0 0;
            letter-spacing: 3px;
        }
        
        /* Main content area */
        .cast-content {
            flex: 1;
            padding: 3rem 4rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
        }
        
        .cast-phase-info {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .cast-phase-title {
            font-size: 4rem;
            margin: 0 0 1rem 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            font-weight: bold;
        }
        
        .cast-phase-subtitle {
            font-size: 1.8rem;
            margin: 0;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .cast-current-player {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 2rem 3rem;
            margin: 2rem 0;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .cast-player-name {
            font-size: 2.5rem;
            margin: 0 0 0.5rem 0;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .cast-player-action {
            font-size: 1.4rem;
            margin: 0;
            opacity: 0.9;
        }
        
        .cast-progress-info {
            background: rgba(255, 152, 0, 0.2);
            border-radius: 15px;
            padding: 1.5rem 2rem;
            margin: 1rem 0;
            text-align: center;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .cast-progress-text {
            font-size: 1.6rem;
            margin: 0;
            font-weight: bold;
        }
        
        /* Slideshow section */
        .cast-slideshow-section {
            margin-top: 2rem;
            height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cast-slideshow-container {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            gap: 4rem;
        }
        
        .cast-original-display {
            flex: 0 0 40%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .cast-original-monster {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 4px solid #FF8C00;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 500px;
            height: auto;
        }
        
        .cast-original-monster h3 {
            color: #8B4513;
            margin: 0 0 1.5rem 0;
            font-weight: bold;
            font-size: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .cast-original-image {
            width: 100%;
            height: 350px;
            object-fit: contain;
            border-radius: 12px;
            border: 2px solid rgba(139, 69, 19, 0.3);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .cast-drawing-display {
            flex: 0 0 55%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .cast-slideshow-title {
            font-size: 2.5rem;
            text-align: center;
            margin: 0 0 2rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .cast-drawing-slide {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 600px;
            height: auto;
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.5s ease-in-out;
            position: absolute;
        }
        
        .cast-drawing-slide.active {
            opacity: 1;
            transform: translateX(0);
            position: relative;
        }
        
        .cast-drawing-slide h3 {
            color: #333;
            margin: 0 0 1.5rem 0;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .cast-drawing-image {
            width: 100%;
            height: 300px;
            object-fit: contain;
            border-radius: 12px;
            border: 2px solid rgba(0,0,0,0.1);
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .cast-drawing-image.loaded {
            opacity: 1;
        }
        
        .cast-auto-submitted-badge {
            display: inline-block;
            background: #95a5a6;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 0.75rem;
        }
        
        .cast-slideshow-progress {
            position: absolute;
            bottom: -3rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .cast-progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: background 0.3s ease;
        }
        
        .cast-progress-dot.active {
            background: #FFD700;
            transform: scale(1.2);
        }
        
        .cast-no-drawings {
            text-align: center;
            font-size: 2rem;
            color: #f39c12;
            opacity: 0.8;
        }
        
        /* Connection states */
        .cast-connecting {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        
        .cast-connecting h2 {
            font-size: 3rem;
            margin: 0 0 1rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .cast-connecting p {
            font-size: 1.5rem;
            opacity: 0.8;
            margin: 0;
        }
        
        .cast-loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { 
            display: none !important; 
        }
        
        /* Responsive for different TV sizes */
        @media (max-width: 1200px) {
            .cast-header {
                padding: 2rem 3rem;
            }
            
            .cast-timer {
                font-size: 2.5rem;
                padding: 1.2rem 2.5rem;
                min-width: 160px;
            }
            
            .cast-phase-title {
                font-size: 3rem;
            }
            
            .cast-player-name {
                font-size: 2rem;
            }
            
            .cast-slideshow-container {
                gap: 2rem;
            }
            
            .cast-original-image {
                height: 250px;
            }
            
            .cast-drawing-image {
                height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="cast-display">
        <!-- Header -->
        <div class="cast-header">
            <div class="cast-title">Drawblins</div>
            <div class="cast-timer" id="cast-timer">00:00</div>
            <div class="cast-room-info">
                <p class="cast-room-code">Room Code:</p>
                <p class="cast-room-code-value" id="cast-room-code">----</p>
            </div>
        </div>
        
        <!-- Main content -->
        <div class="cast-content">
            <!-- Connecting state -->
            <div id="cast-connecting" class="cast-connecting">
                <div class="cast-loading-spinner"></div>
                <h2>Connecting to Game...</h2>
                <p>Waiting for players to join</p>
            </div>
            
            <!-- Game content -->
            <div id="cast-game-content" class="hidden">
                <div class="cast-phase-info">
                    <h1 class="cast-phase-title" id="cast-phase-title">Welcome to Drawblins!</h1>
                    <p class="cast-phase-subtitle" id="cast-phase-subtitle">Get ready to play</p>
                </div>
                
                <div id="cast-current-player" class="cast-current-player hidden">
                    <h2 class="cast-player-name" id="cast-player-name">Player Name</h2>
                    <p class="cast-player-action" id="cast-player-action">is getting ready</p>
                </div>
                
                <div id="cast-progress" class="cast-progress-info hidden">
                    <p class="cast-progress-text">
                        Drawings submitted: <span id="cast-progress-count">0</span> / <span id="cast-progress-total">0</span>
                    </p>
                </div>
            </div>
            
            <!-- Slideshow display -->
            <div id="cast-slideshow" class="cast-slideshow-section hidden">
                <div class="cast-slideshow-container">
                    <!-- Original monster (left side) -->
                    <div class="cast-original-display">
                        <div class="cast-original-monster">
                            <h3>Original Monster</h3>
                            <img id="cast-original-image" class="cast-original-image" src="" alt="Original Monster">
                        </div>
                    </div>
                    
                    <!-- Drawing slideshow (right side) -->
                    <div class="cast-drawing-display">
                        <h2 class="cast-slideshow-title">Player Drawings</h2>
                        <div id="cast-slideshow-container">
                            <!-- Drawing slides will be inserted here -->
                        </div>
                        <div id="cast-slideshow-progress" class="cast-slideshow-progress">
                            <!-- Progress dots will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cast SDK -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    
    <script>
        // Cast Application Framework setup
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        
        // Game state
        let gameState = null;
        let room = null;
        let roomCode = null;
        
        // Slideshow state
        let slideshowDrawings = [];
        let currentSlideIndex = 0;
        let slideshowInterval = null;
        let originalMonsterUrl = null;
        
        // Image handling
        const imageCache = new Map();
        const IMAGE_BASE_URLS = [
            'https://teejaywilliamson.github.io/Drawblins/images/',
            './images/',
            '../images/',
            'images/'
        ];
        
        // Custom message bus for game data
        const CUSTOM_CHANNEL = 'urn:x-cast:com.drawblins.gamedata';
        
        context.addCustomMessageListener(CUSTOM_CHANNEL, (customEvent) => {
            const message = customEvent.data;
            console.log('ðŸŽ¬ Received cast message:', message.type);
            
            switch (message.type) {
                case 'game-update':
                    handleGameUpdate(message.gameState, message.room);
                    break;
                case 'timer-update':
                    updateTimer(message.timeString, message.timeLeft);
                    break;
                case 'slideshow-start':
                    handleSlideshowStart(message.originalMonster, message.totalDrawings);
                    break;
                case 'slideshow-drawing':
                    handleSlideshowDrawing(message);
                    break;
                case 'room-code':
                    setRoomCode(message.roomCode);
                    break;
                case 'drawing-progress':
                    updateDrawingProgress(message);
                    break;
                case 'game-finished':
                    handleGameFinished(message);
                    break;
            }
        });
        
        // Image loading utility
        function loadImageWithFallbacks(imageName, callback) {
            if (imageCache.has(imageName)) {
                callback(imageCache.get(imageName), null);
                return;
            }
            
            let currentUrlIndex = 0;
            
            function tryNextUrl() {
                if (currentUrlIndex >= IMAGE_BASE_URLS.length) {
                    console.error('Failed to load image after trying all URLs:', imageName);
                    callback(null, 'Failed to load image');
                    return;
                }
                
                const url = IMAGE_BASE_URLS[currentUrlIndex] + imageName;
                
                const img = new Image();
                
                img.onload = function() {
                    imageCache.set(imageName, url);
                    callback(url, null);
                };
                
                img.onerror = function() {
                    currentUrlIndex++;
                    tryNextUrl();
                };
                
                img.src = url;
            }
            
            tryNextUrl();
        }
        
        // Handle slideshow start
        function handleSlideshowStart(originalMonster, totalDrawings) {
            console.log('ðŸŽ¬ Starting slideshow with original monster:', originalMonster);
            
            // Clear previous slideshow
            clearSlideshow();
            slideshowDrawings = [];
            currentSlideIndex = 0;
            
            // Load and display original monster
            if (originalMonster) {
                loadImageWithFallbacks(originalMonster, (imageUrl, error) => {
                    const originalImage = document.getElementById('cast-original-image');
                    if (imageUrl && originalImage) {
                        originalImage.onload = () => {
                            originalImage.classList.add('loaded');
                        };
                        originalImage.src = imageUrl;
                        originalMonsterUrl = imageUrl;
                    } else {
                        console.error('Failed to load original monster image');
                    }
                });
            }
            
            // Show slideshow section
            showSlideshow();
        }
        
        // Handle individual slideshow drawing
        function handleSlideshowDrawing(drawingData) {
            console.log('ðŸŽ¨ Received slideshow drawing for:', drawingData.playerName);
            
            // Add to slideshow drawings
            slideshowDrawings.push({
                playerName: drawingData.playerName,
                imageData: drawingData.imageData,
                autoSubmitted: drawingData.autoSubmitted,
                index: drawingData.index
            });
            
            // If this is the first drawing, start the slideshow
            if (slideshowDrawings.length === 1) {
                startSlideshow();
            } else {
                // Update progress dots
                updateProgressDots();
            }
        }
        
        // Show slideshow section
        function showSlideshow() {
            document.getElementById('cast-connecting').classList.add('hidden');
            document.getElementById('cast-game-content').classList.add('hidden');
            document.getElementById('cast-slideshow').classList.remove('hidden');
        }
        
        // Start the slideshow rotation
        function startSlideshow() {
            console.log('ðŸŽ¬ Starting slideshow with', slideshowDrawings.length, 'drawings');
            
            if (slideshowDrawings.length === 0) {
                showNoDrawingsMessage();
                return;
            }
            
            // Create slides
            createSlides();
            
            // Show first slide
            showSlide(0);
            
            // Start rotation if more than one drawing
            if (slideshowDrawings.length > 1) {
                slideshowInterval = setInterval(() => {
                    currentSlideIndex = (currentSlideIndex + 1) % slideshowDrawings.length;
                    showSlide(currentSlideIndex);
                }, 5000); // 5 seconds per slide
            }
        }
        
        // Create slide elements
        function createSlides() {
            const container = document.getElementById('cast-slideshow-container');
            const progressContainer = document.getElementById('cast-slideshow-progress');
            
            // Clear existing slides
            container.innerHTML = '';
            progressContainer.innerHTML = '';
            
            slideshowDrawings.forEach((drawing, index) => {
                // Create slide
                const slide = document.createElement('div');
                slide.className = 'cast-drawing-slide';
                slide.id = `slide-${index}`;
                
                slide.innerHTML = `
                    <h3>
                        ${drawing.playerName}
                        ${drawing.autoSubmitted ? '<span class="cast-auto-submitted-badge">Auto</span>' : ''}
                    </h3>
                    <img class="cast-drawing-image" alt="${drawing.playerName}'s drawing">
                `;
                
                container.appendChild(slide);
                
                // Load image
                const img = slide.querySelector('.cast-drawing-image');
                if (drawing.imageData) {
                    img.onload = () => {
                        img.classList.add('loaded');
                    };
                    img.onerror = () => {
                        console.error('Failed to load drawing image for', drawing.playerName);
                    };
                    img.src = drawing.imageData;
                }
                
                // Create progress dot
                const dot = document.createElement('div');
                dot.className = 'cast-progress-dot';
                dot.id = `dot-${index}`;
                progressContainer.appendChild(dot);
            });
        }
        
        // Show specific slide
        function showSlide(index) {
            console.log('ðŸŽ¬ Showing slide', index + 1, 'of', slideshowDrawings.length);
            
            // Hide all slides
            const slides = document.querySelectorAll('.cast-drawing-slide');
            slides.forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Show current slide
            const currentSlide = document.getElementById(`slide-${index}`);
            if (currentSlide) {
                setTimeout(() => {
                    currentSlide.classList.add('active');
                }, 100); // Small delay for smooth transition
            }
            
            // Update progress dots
            updateProgressDots();
        }
        
        // Update progress dots
        function updateProgressDots() {
            const dots = document.querySelectorAll('.cast-progress-dot');
            dots.forEach((dot, index) => {
                if (index === currentSlideIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }
        
        // Show no drawings message
        function showNoDrawingsMessage() {
            const container = document.getElementById('cast-slideshow-container');
            container.innerHTML = '<div class="cast-no-drawings">No drawings submitted</div>';
        }
        
        // Clear slideshow
        function clearSlideshow() {
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
            
            const container = document.getElementById('cast-slideshow-container');
            const progressContainer = document.getElementById('cast-slideshow-progress');
            
            if (container) container.innerHTML = '';
            if (progressContainer) progressContainer.innerHTML = '';
            
            slideshowDrawings = [];
            currentSlideIndex = 0;
        }
        
        // Handle game updates
        function handleGameUpdate(newGameState, newRoom) {
            gameState = newGameState;
            room = newRoom;
            
            if (room && room.code) {
                setRoomCode(room.code);
            }
            
            // Clear slideshow when game updates (new phase)
            if (gameState && gameState.phase !== 'reveal') {
                clearSlideshow();
            }
            
            updateCastDisplay();
        }
        
        function setRoomCode(code) {
            roomCode = code;
            document.getElementById('cast-room-code').textContent = code || '----';
        }
        
        function showConnecting() {
            document.getElementById('cast-connecting').classList.remove('hidden');
            document.getElementById('cast-game-content').classList.add('hidden');
            document.getElementById('cast-slideshow').classList.add('hidden');
        }
        
        function showGameContent() {
            document.getElementById('cast-connecting').classList.add('hidden');
            document.getElementById('cast-game-content').classList.remove('hidden');
            document.getElementById('cast-slideshow').classList.add('hidden');
        }
        
        function updateCastDisplay() {
            if (!gameState || !room) {
                showConnecting();
                return;
            }
            
            // Don't override slideshow display during reveal phase
            if (gameState.phase === 'reveal' && slideshowDrawings.length > 0) {
                return;
            }
            
            showGameContent();
            
            const currentPlayer = room.players.find(p => p.id === gameState.currentDrawer);
            
            // Update phase info
            const phaseTitle = document.getElementById('cast-phase-title');
            const phaseSubtitle = document.getElementById('cast-phase-subtitle');
            const currentPlayerDiv = document.getElementById('cast-current-player');
            const progressDiv = document.getElementById('cast-progress');
            
            switch (gameState.phase) {
                case 'studying':
                    phaseTitle.textContent = `Round ${gameState.currentRound} - Study Phase`;
                    phaseSubtitle.textContent = 'Player is memorizing the monster';
                    
                    if (currentPlayer) {
                        document.getElementById('cast-player-name').textContent = currentPlayer.name;
                        document.getElementById('cast-player-action').textContent = 'is studying the monster';
                        currentPlayerDiv.classList.remove('hidden');
                    }
                    
                    progressDiv.classList.add('hidden');
                    break;
                    
                case 'drawing':
                    phaseTitle.textContent = `Round ${gameState.currentRound} - Drawing Phase`;
                    phaseSubtitle.textContent = 'Draw what you hear!';
                    
                    if (currentPlayer) {
                        document.getElementById('cast-player-name').textContent = currentPlayer.name;
                        document.getElementById('cast-player-action').textContent = 'is describing the monster';
                        currentPlayerDiv.classList.remove('hidden');
                    }
                    
                    // Update progress
                    const expectedSubmissions = room.players.filter(p => p.id !== gameState.currentDrawer).length;
                    document.getElementById('cast-progress-count').textContent = gameState.drawings?.length || 0;
                    document.getElementById('cast-progress-total').textContent = expectedSubmissions;
                    progressDiv.classList.remove('hidden');
                    break;
                    
                default:
                    phaseTitle.textContent = 'Drawblins Party Mode';
                    phaseSubtitle.textContent = 'Waiting for game to start...';
                    currentPlayerDiv.classList.add('hidden');
                    progressDiv.classList.add('hidden');
            }
        }
        
        function updateTimer(timeString, timeLeft) {
            const timerElement = document.getElementById('cast-timer');
            if (timerElement) {
                timerElement.textContent = timeString;
                
                // Add urgent class for last 10 seconds
                if (timeLeft <= 10 && timeLeft > 0) {
                    timerElement.classList.add('timer-urgent');
                } else {
                    timerElement.classList.remove('timer-urgent');
                }
            }
        }
        
        function updateDrawingProgress(data) {
            const progressCount = document.getElementById('cast-progress-count');
            const progressTotal = document.getElementById('cast-progress-total');
            
            if (progressCount) progressCount.textContent = data.totalSubmitted || 0;
            if (progressTotal) progressTotal.textContent = data.totalExpected || 0;
        }
        
        function handleGameFinished(data) {
            console.log('Game finished');
            clearSlideshow();
            
            const phaseTitle = document.getElementById('cast-phase-title');
            const phaseSubtitle = document.getElementById('cast-phase-subtitle');
            const currentPlayerDiv = document.getElementById('cast-current-player');
            const progressDiv = document.getElementById('cast-progress');
            
            if (phaseTitle) phaseTitle.textContent = 'Game Complete!';
            if (phaseSubtitle) phaseSubtitle.textContent = 'Thanks for playing Drawblins!';
            if (currentPlayerDiv) currentPlayerDiv.classList.add('hidden');
            if (progressDiv) progressDiv.classList.add('hidden');
            
            showGameContent();
        }
        
        // Start the receiver
        context.start({
            // Disable idle timeout for long games
            maxInactivity: 3600 // 1 hour
        });
        
        // Show connecting state initially
        showConnecting();
        
        console.log('Drawblins Cast Receiver with Slideshow initialized');
    </script>
</body>
</html>