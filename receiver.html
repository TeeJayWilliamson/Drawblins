<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawblins Web Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        .viewer-display {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        
        /* Header with room code and timer */
        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 3rem;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .viewer-title {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .viewer-timer {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 30px;
            font-size: 2rem;
            font-weight: bold;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .viewer-timer.timer-urgent {
            background: #e74c3c;
        }
        
        .viewer-room-info {
            text-align: right;
        }
        
        .viewer-room-code {
            font-size: 1rem;
            opacity: 0.8;
            margin: 0;
        }
        
        .viewer-room-code-value {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0.5rem 0 0 0;
            letter-spacing: 2px;
        }
        
        /* Main content area */
        .viewer-content {
            flex: 1;
            padding: 2rem 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
            min-height: 0;
        }
        
        .viewer-phase-info {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .viewer-phase-title {
            font-size: 3rem;
            margin: 0 0 1rem 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
            font-weight: bold;
        }
        
        .viewer-phase-subtitle {
            font-size: 1.5rem;
            margin: 0;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .viewer-current-player {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin: 1.5rem 0;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .viewer-player-name {
            font-size: 2rem;
            margin: 0 0 0.5rem 0;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .viewer-player-action {
            font-size: 1.2rem;
            margin: 0;
            opacity: 0.9;
        }
        
        .viewer-progress-info {
            background: rgba(255, 152, 0, 0.2);
            border-radius: 15px;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            text-align: center;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        .viewer-progress-text {
            font-size: 1.4rem;
            margin: 0;
            font-weight: bold;
        }

        /* Room input section */
        .room-input-section {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 500px;
            backdrop-filter: blur(10px);
        }

        .room-input-section h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .room-input {
            padding: 1rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            text-align: center;
            margin: 1rem;
            width: 200px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .connect-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            margin-left: 1rem;
            transition: background 0.3s ease;
        }

        .connect-btn:hover:not(:disabled) {
            background: #229954;
        }

        .connect-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .status-indicator {
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        .status-indicator.connected {
            color: #27ae60;
        }

        .status-indicator.error {
            color: #e74c3c;
        }
        
        /* Slideshow section */
        .viewer-slideshow-section {
            flex: 1;
            display: flex;
            align-items: stretch;
            justify-content: center;
            gap: 2rem;
            min-height: 0;
            padding: 1rem 0;
        }
        
        .viewer-original-display {
            flex: 0 0 35%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .viewer-original-monster {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 3px solid #FF8C00;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .viewer-original-monster h3 {
            color: #8B4513;
            margin: 0 0 1rem 0;
            font-weight: bold;
            font-size: 1.5rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        .viewer-original-image {
            width: 100%;
            height: 250px;
            object-fit: contain;
            border-radius: 10px;
            border: 2px solid rgba(139, 69, 19, 0.3);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .viewer-drawing-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 0;
            position: relative;
        }
        
        .viewer-slideshow-title {
            font-size: 2rem;
            text-align: center;
            margin: 0 0 1.5rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #viewer-slideshow-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .viewer-drawing-slide {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        .viewer-drawing-slide.active {
            opacity: 1;
        }
        
        .viewer-drawing-slide h3 {
            color: #333;
            margin: 0 0 1rem 0;
            font-size: 1.4rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .viewer-drawing-image {
            width: 100%;
            flex: 1;
            object-fit: contain;
            border-radius: 10px;
            border: 2px solid rgba(0,0,0,0.1);
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 200px;
        }
        
        .viewer-auto-submitted-badge {
            display: inline-block;
            background: #95a5a6;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        
        .viewer-slideshow-progress {
            position: absolute;
            bottom: -3rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            align-items: center;
            z-index: 10;
        }
        
        .viewer-progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .viewer-progress-dot.active {
            background: #FFD700;
            transform: scale(1.3);
        }
        
        .hidden { 
            display: none !important; 
        }
    </style>
</head>
<body>
    <div class="viewer-display">
        <!-- Header -->
        <div class="viewer-header">
            <div class="viewer-title">Drawblins Web Viewer</div>
            <div class="viewer-timer" id="viewer-timer">00:00</div>
            <div class="viewer-room-info">
                <p class="viewer-room-code">Room Code:</p>
                <p class="viewer-room-code-value" id="viewer-room-code">----</p>
            </div>
        </div>
        
        <!-- Main content -->
        <div class="viewer-content">
            <!-- Room connection -->
            <div id="room-connection" class="room-input-section">
                <h2>Connect to Game Room</h2>
                <div>
                    <input type="text" id="room-code-input" class="room-input" placeholder="ABCD" maxlength="4">
                    <button id="connect-btn" class="connect-btn">Connect</button>
                </div>
                <div id="connection-status" class="status-indicator">Enter room code to watch the game</div>
            </div>
            
            <!-- Game content -->
            <div id="viewer-game-content" class="hidden">
                <div class="viewer-phase-info">
                    <h1 class="viewer-phase-title" id="viewer-phase-title">Welcome to Drawblins!</h1>
                    <p class="viewer-phase-subtitle" id="viewer-phase-subtitle">Get ready to play</p>
                </div>
                
                <div id="viewer-current-player" class="viewer-current-player hidden">
                    <h2 class="viewer-player-name" id="viewer-player-name">Player Name</h2>
                    <p class="viewer-player-action" id="viewer-player-action">is getting ready</p>
                </div>
                
                <div id="viewer-progress" class="viewer-progress-info hidden">
                    <p class="viewer-progress-text">
                        Drawings submitted: <span id="viewer-progress-count">0</span> / <span id="viewer-progress-total">0</span>
                    </p>
                </div>
            </div>
            
            <!-- Slideshow display -->
            <div id="viewer-slideshow" class="viewer-slideshow-section hidden">
                <!-- Original monster (left side) -->
                <div class="viewer-original-display">
                    <div class="viewer-original-monster">
                        <h3>Original Monster</h3>
                        <img id="viewer-original-image" class="viewer-original-image" src="" alt="Original Monster">
                    </div>
                </div>
                
                <!-- Drawing slideshow (right side) -->
                <div class="viewer-drawing-display">
                    <div class="viewer-slideshow-title">Player Drawings</div>
                    <div id="viewer-slideshow-container">
                        <!-- Drawing slides will be inserted here -->
                    </div>
                    <div id="viewer-slideshow-progress" class="viewer-slideshow-progress">
                        <!-- Progress dots will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Socket.IO for WebSocket connection -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <script>
        class DrawblinsWebViewer {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.roomCode = null;
                this.gameState = null;
                this.room = null;
                this.serverUrl = 'https://drawblins-production.up.railway.app';
                
                // Slideshow state
                this.slideshowDrawings = [];
                this.currentSlideIndex = 0;
                this.slideshowInterval = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                const connectBtn = document.getElementById('connect-btn');
                const roomInput = document.getElementById('room-code-input');
                
                connectBtn.addEventListener('click', () => this.connectToRoom());
                
                roomInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.connectToRoom();
                    }
                });
            }
            
            connectToRoom() {
                const roomInput = document.getElementById('room-code-input');
                const roomCode = roomInput.value.trim().toUpperCase();
                
                if (!roomCode || roomCode.length !== 4) {
                    this.showStatus('Please enter a valid 4-letter room code', 'error');
                    return;
                }
                
                this.roomCode = roomCode;
                this.showStatus('Connecting...', '');
                
                this.connect();
            }
            
            connect() {
                if (this.socket && this.isConnected) {
                    this.socket.disconnect();
                }
                
                this.socket = io(this.serverUrl, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000
                });
                
                this.socket.on('connect', () => {
                    console.log('Connected to server');
                    this.isConnected = true;
                    this.showStatus('Connected! Joining room...', '');
                    
                    // Connect as spectator (doesn't join as player)
                    this.socket.emit('spectate-room', {
                        roomCode: this.roomCode
                    });
                });
                
                this.socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    this.isConnected = false;
                    this.showStatus('Disconnected from server', 'error');
                    this.showRoomConnection();
                });
                
                this.socket.on('spectate-success', (data) => {
                    this.room = data.room;
                    this.showStatus('Connected as spectator!', 'connected');
                    this.showGameContent();
                    this.updateRoomCode(this.roomCode);
                    
                    // If game is in progress, update display
                    if (this.room.gameState) {
                        this.handleGameUpdate(this.room.gameState);
                    }
                });
                
                this.socket.on('spectate-error', (data) => {
                    this.showStatus(data.error || 'Room not found', 'error');
                });
                
                this.socket.on('room-joined', (data) => {
                    // Fallback if spectate not supported
                    if (data.success) {
                        this.room = data.room;
                        this.showStatus('Connected to room!', 'connected');
                        this.showGameContent();
                        this.updateRoomCode(this.roomCode);
                        
                        // If game is in progress, update display
                        if (this.room.gameState) {
                            this.handleGameUpdate(this.room.gameState);
                        }
                    } else {
                        this.showStatus(data.error || 'Failed to join room', 'error');
                    }
                });
                
                this.socket.on('game-started', (data) => {
                    this.room = data.room;
                    this.handleGameUpdate(data.gameState);
                });
                
                this.socket.on('phase-changed', (data) => {
                    this.room = data.room;
                    this.handleGameUpdate(data.gameState);
                });
                
                this.socket.on('timer-update', (data) => {
                    this.updateTimer(data.timeLeft);
                });
                
                this.socket.on('drawing-submitted', (data) => {
                    this.updateDrawingProgress(data);
                });
                
                this.socket.on('game-finished', (data) => {
                    this.handleGameFinished(data);
                });
                
                // Handle reveal phase with drawings
                this.socket.on('phase-changed', (data) => {
                    this.room = data.room;
                    
                    if (data.gameState.phase === 'reveal' && data.allDrawings) {
                        this.showDrawingsSlideshow(data.allDrawings, data.originalMonster);
                    } else {
                        this.handleGameUpdate(data.gameState);
                    }
                });
            }
            
            showStatus(message, type = '') {
                const status = document.getElementById('connection-status');
                status.textContent = message;
                status.className = `status-indicator ${type}`;
            }
            
            showRoomConnection() {
                document.getElementById('room-connection').classList.remove('hidden');
                document.getElementById('viewer-game-content').classList.add('hidden');
                document.getElementById('viewer-slideshow').classList.add('hidden');
            }
            
            showGameContent() {
                document.getElementById('room-connection').classList.add('hidden');
                document.getElementById('viewer-game-content').classList.remove('hidden');
                document.getElementById('viewer-slideshow').classList.add('hidden');
            }
            
            showSlideshow() {
                document.getElementById('room-connection').classList.add('hidden');
                document.getElementById('viewer-game-content').classList.add('hidden');
                document.getElementById('viewer-slideshow').classList.remove('hidden');
            }
            
            updateRoomCode(code) {
                document.getElementById('viewer-room-code').textContent = code || '----';
            }
            
            handleGameUpdate(gameState) {
                this.gameState = gameState;
                
                if (gameState.phase === 'reveal') {
                    return; // Let slideshow handle reveal phase
                }
                
                this.showGameContent();
                
                const currentPlayer = this.room.players.find(p => p.id === gameState.currentDrawer);
                
                // Update phase info
                const phaseTitle = document.getElementById('viewer-phase-title');
                const phaseSubtitle = document.getElementById('viewer-phase-subtitle');
                const currentPlayerDiv = document.getElementById('viewer-current-player');
                const progressDiv = document.getElementById('viewer-progress');
                
                switch (gameState.phase) {
                    case 'studying':
                        phaseTitle.textContent = `Round ${gameState.currentRound} - Study Phase`;
                        phaseSubtitle.textContent = 'Player is memorizing the monster';
                        
                        if (currentPlayer) {
                            document.getElementById('viewer-player-name').textContent = currentPlayer.name;
                            document.getElementById('viewer-player-action').textContent = 'is studying the monster';
                            currentPlayerDiv.classList.remove('hidden');
                        }
                        
                        progressDiv.classList.add('hidden');
                        break;
                        
                    case 'drawing':
                        phaseTitle.textContent = `Round ${gameState.currentRound} - Drawing Phase`;
                        phaseSubtitle.textContent = 'Draw what you hear!';
                        
                        if (currentPlayer) {
                            document.getElementById('viewer-player-name').textContent = currentPlayer.name;
                            document.getElementById('viewer-player-action').textContent = 'is describing the monster';
                            currentPlayerDiv.classList.remove('hidden');
                        }
                        
                        // Update progress
                        const expectedSubmissions = this.room.players.filter(p => p.id !== gameState.currentDrawer).length;
                        document.getElementById('viewer-progress-count').textContent = gameState.drawings?.length || 0;
                        document.getElementById('viewer-progress-total').textContent = expectedSubmissions;
                        progressDiv.classList.remove('hidden');
                        break;
                        
                    default:
                        phaseTitle.textContent = 'Drawblins Party Mode';
                        phaseSubtitle.textContent = 'Waiting for game to start...';
                        currentPlayerDiv.classList.add('hidden');
                        progressDiv.classList.add('hidden');
                }
            }
            
            updateTimer(timeLeft) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const timerElement = document.getElementById('viewer-timer');
                if (timerElement) {
                    timerElement.textContent = timeString;
                    
                    if (timeLeft <= 10 && timeLeft > 0) {
                        timerElement.classList.add('timer-urgent');
                    } else {
                        timerElement.classList.remove('timer-urgent');
                    }
                }
            }
            
            updateDrawingProgress(data) {
                const progressCount = document.getElementById('viewer-progress-count');
                const progressTotal = document.getElementById('viewer-progress-total');
                
                if (progressCount) progressCount.textContent = data.totalSubmitted || 0;
                if (progressTotal) progressTotal.textContent = data.totalExpected || 0;
            }
            
            showDrawingsSlideshow(drawings, originalMonster) {
                this.showSlideshow();
                
                // Clear previous slideshow
                this.clearSlideshow();
                this.slideshowDrawings = drawings || [];
                
                // Show original monster
                if (originalMonster) {
                    const originalImage = document.getElementById('viewer-original-image');
                    originalImage.src = `https://teejaywilliamson.github.io/Drawblins/images/${originalMonster}`;
                }
                
                // Create slides
                if (this.slideshowDrawings.length > 0) {
                    this.createSlides();
                    this.showSlide(0);
                    
                    if (this.slideshowDrawings.length > 1) {
                        this.startAutoRotation();
                    }
                }
            }
            
            createSlides() {
                const container = document.getElementById('viewer-slideshow-container');
                const progressContainer = document.getElementById('viewer-slideshow-progress');
                
                container.innerHTML = '';
                progressContainer.innerHTML = '';
                
                this.slideshowDrawings.forEach((drawing, index) => {
                    // Create slide
                    const slide = document.createElement('div');
                    slide.className = 'viewer-drawing-slide';
                    slide.innerHTML = `
                        <h3>
                            ${drawing.playerName}
                            ${drawing.autoSubmitted ? '<span class="viewer-auto-submitted-badge">Auto</span>' : ''}
                        </h3>
                        <img class="viewer-drawing-image" src="${drawing.imageData}" alt="${drawing.playerName}'s drawing">
                    `;
                    container.appendChild(slide);
                    
                    // Create progress dot
                    const dot = document.createElement('div');
                    dot.className = 'viewer-progress-dot';
                    progressContainer.appendChild(dot);
                });
            }
            
            showSlide(index) {
                if (index >= this.slideshowDrawings.length || index < 0) return;
                
                this.currentSlideIndex = index;
                
                const slides = document.querySelectorAll('.viewer-drawing-slide');
                const dots = document.querySelectorAll('.viewer-progress-dot');
                
                slides.forEach((slide, slideIndex) => {
                    if (slideIndex === index) {
                        slide.classList.add('active');
                    } else {
                        slide.classList.remove('active');
                    }
                });
                
                dots.forEach((dot, dotIndex) => {
                    if (dotIndex === index) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
            
            startAutoRotation() {
                if (this.slideshowInterval) {
                    clearInterval(this.slideshowInterval);
                }
                
                this.slideshowInterval = setInterval(() => {
                    const nextIndex = (this.currentSlideIndex + 1) % this.slideshowDrawings.length;
                    this.showSlide(nextIndex);
                }, 4000);
            }
            
            clearSlideshow() {
                if (this.slideshowInterval) {
                    clearInterval(this.slideshowInterval);
                    this.slideshowInterval = null;
                }
                
                const container = document.getElementById('viewer-slideshow-container');
                const progressContainer = document.getElementById('viewer-slideshow-progress');
                
                if (container) container.innerHTML = '';
                if (progressContainer) progressContainer.innerHTML = '';
                
                this.slideshowDrawings = [];
                this.currentSlideIndex = 0;
            }
            
            handleGameFinished(data) {
                this.clearSlideshow();
                this.showGameContent();
                
                const phaseTitle = document.getElementById('viewer-phase-title');
                const phaseSubtitle = document.getElementById('viewer-phase-subtitle');
                
                if (phaseTitle) phaseTitle.textContent = 'Game Complete!';
                if (phaseSubtitle) phaseSubtitle.textContent = 'Thanks for playing Drawblins!';
            }
        }
        
        // Initialize the web viewer
        document.addEventListener('DOMContentLoaded', () => {
            new DrawblinsWebViewer();
        });
    </script>
</body>
</html>